<!DOCTYPE html>
<html>
  <head>
    <title>MorphL | Test API Request</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script>
      // !!!!! Set your values for the below variables !!!!!!!!
      var morphlAPIUrl = "https://test.api.url";

      var morphlAccessToken =
        "token obtained from the /authorized endpoint, using API key & API secret";

      // !!!!! Set below the threshold for the predictions values. They will be used only if they are higher than the below value !!!!!!!!
      var morphlShoppingStageThreshold = 0.5;

      /**
       * Return the shopping stage with the highest probability.

       * @param object shoppingStages
       * @return string all_visits | product_view | add_to_cart | checkout_with_add_to_cart | checkout_without_add_to_cart | transaction
       */
      function getMorphlShoppingStage(shoppingStages) {
        var highestProbability = 0;
        var nextStage = "n/a";

        // List with allowed stages
        var allowedStages = [
          "all_visits",
          "product_view",
          "add_to_cart",
          "checkout_with_add_to_cart",
          "checkout_without_add_to_cart",
          "transaction"
        ];

        for (var i = 0; i < allowedStages.length; i++) {
          var stage = allowedStages[i];

          // Check if the stage exists as a property in the shoppingStages object
          if (shoppingStages[stage] !== null) {
            // Convert the value in a number
            var shoppingStageValue = Number(shoppingStages[stage]);

            // Compare value to the highest probability. Use it only if higher than threshold.
            if (
              shoppingStageValue > morphlShoppingStageThreshold &&
              shoppingStageValue > highestProbability
            ) {
              // We have a stage with a higher probability, so overwrite our control variables
              highestProbability = shoppingStageValue;
              nextStage = stage;
            }
          }
        }

        return nextStage;
      }

      /**
       * Get a browser cookie
       *
       * @param string cname = The cookie name
       * @return string = The cookie value or an empty string ("") if the cookie doesn't exist
       */
      function getMorphLCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(";");
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }

      /**
       * Get the client id from the Google Analytics cookie.
       */
      function getMorphlGoogleAnalyticsClientId() {
        var gaCookie = getMorphLCookie("_ga");

        if (gaCookie === "") {
          return null;
        }

        // Parse the _ga cookie value to the right format.
        var lastElements = gaCookie.split(".").slice(-2);

        if (lastElements.length == 2) {
          return "GA" + lastElements.join(".");
        }

        return null;
      }

      /**
       * Interogate MorphL API and get the value of the prediction for the client ID.
       * Display popups depending on the shopping stage with the highest probability.
       */
      function getMorphlPrediction() {
        // Set up our HTTP request
        var xhr = new XMLHttpRequest();

        // Setup our listener to process completed requests
        xhr.onload = function() {
          // Set a default value for the shopping stage
          var shoppingStage = "n/a";

          // Process our return data
          if (xhr.status == 200) {
            // This will run when the request is successful
            var morphlRes = JSON.parse(xhr.response);

            // Validate the response received from the API
            // Check if the client id has a valid prediction
            if (
              morphlRes &&
              morphlRes.status &&
              Number(morphlRes.status) == 1 &&
              morphlRes.prediction &&
              typeof morphlRes.prediction === "object" &&
              morphlRes.prediction.shopping_stages &&
              typeof morphlRes.prediction.shopping_stages === "object"
            ) {
              // Get the shopping stage with the highest probability, above the threshold
              var nextShoppingStage = getMorphlShoppingStage(
                morphlRes.prediction.shopping_stages
              );

              console.log("Next shopping stage is: ", nextShoppingStage);

              // We're going to use only the stages related to the cart - checkout - transaction process.
              if (
                [
                  "add_to_cart",
                  "checkout_with_add_to_cart",
                  "checkout_without_add_to_cart",
                  "transaction"
                ].indexOf(nextShoppingStage) !== -1
              ) {
                shoppingStage = nextShoppingStage;
              }
            }

            if (shoppingStage != "n/a") {
              // !!!!!! This is where we display our call-to-action to the user
              console.log("Call to action for the", shoppingStage, "stage");
            } else {
              // !!!!!! Take other actions.
              console.log("Take other actions");
            }
          }
        };

        var clientId = getMorphlGoogleAnalyticsClientId();

        if (clientId !== null) {
          // Create and send the GET request
          // The first argument is the post type (GET, POST, PUT, DELETE, etc.)
          // The second argument is the endpoint URL
          xhr.open("GET", String(morphlAPIUrl) + "" + String(clientId));
          xhr.setRequestHeader("Authorization", morphlAccessToken);
          xhr.send();
        }
      }
    </script>
  </head>
  <body onload="javascript:getMorphlPrediction()"></body>
</html>
